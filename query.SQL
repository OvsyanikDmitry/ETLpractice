

CREATE TABLE  DE2TM.DOVS_DWH_DIM_CLNT_HIST(
CLIENT_ID VARCHAR2(20 BYTE),
LAST_NAME VARCHAR2(100 BYTE),
FIRST_NAME VARCHAR2(100 BYTE),
PATRONYMIC VARCHAR2(100 BYTE),
DATE_OF_BIRTH DATE,
PASSPORT_NUM VARCHAR2(15 BYTE),
PASSPORT_VALID_TO DATE,
PHONE VARCHAR2(20 BYTE),
EFFECTIVE_FROM_DT DATE,
EFFECTIVE_TO_DT DATE DEFAULT TO_DATE('5999-12-31', 'YYYY-MM-DD'),
DELETED_FLG INT DEFAULT 0
);

CREATE TABLE  DE2TM.DOVS_DWH_DIM_ACC_HIST(
ACCOUNT_NUM VARCHAR2(20 BYTE),
VALID_TO DATE,
CLIENT VARCHAR2(20 BYTE),
EFFECTIVE_FROM_DT DATE,
EFFECTIVE_TO_DT DATE DEFAULT TO_DATE('5999-12-31', 'YYYY-MM-DD'),
DELETED_FLG INT DEFAULT 0
);



CREATE TABLE  DE2TM.DOVS_DWH_DIM_CARDS_HIST(
CARD_NUM VARCHAR2(20 BYTE),
ACCOUNT_NUM VARCHAR2(20 BYTE),
EFFECTIVE_FROM_DT DATE,
EFFECTIVE_TO_DT DATE DEFAULT TO_DATE('5999-12-31', 'YYYY-MM-DD'),
DELETED_FLG INT DEFAULT 0
);


CREATE TABLE  DE2TM.DOVS_DWH_DIM_TRMNS_HIST(
TERMINAL_ID VARCHAR2(30 BYTE),
TERMINAL_TYPE VARCHAR2(30 BYTE),
TERMINAL_CITY VARCHAR2(120 BYTE),
TERMINAL_ADDRESS VARCHAR2(120 BYTE),
EFFECTIVE_FROM_DT DATE,
EFFECTIVE_TO_DT DATE DEFAULT TO_DATE('5999-12-31', 'YYYY-MM-DD'),
DELETED_FLG INT DEFAULT 0
);





--FACT
CREATE TABLE  DE2TM.DOVS_DWH_FACT_PSSPRT_BL(
PASSPORT_NUM VARCHAR2(20 BYTE),
ENTRY_DT DATE
);


CREATE TABLE DE2TM.DOVS_DWH_FACT_TRANSACTIONS(
TRANS_ID VARCHAR2(30 BYTE),
TRANS_DATE TIMESTAMP,
AMT DECIMAL(9,2),
CARD_NUM VARCHAR2(20 BYTE),
OPER_TYPE VARCHAR2(20 BYTE),
OPER_RESULT VARCHAR2(20 BYTE),
TERMINAL VARCHAR2(20 BYTE)
);




--STG


CREATE TABLE DE2TM.DOVS_STG_ACCOUNTS
(ACCOUNT_NUM CHAR(20 BYTE),
VALID_TO DATE,
CLIENT VARCHAR2(20 BYTE),
CREATE_DT DATE,
UPDATE_DT DATE
);

CREATE TABLE DE2TM.DOVS_STG_CARDS
(CARD_NUM VARCHAR2(20 BYTE),
ACCOUNT_NUM VARCHAR2(20 BYTE),
CREATE_DT DATE,
UPDATE_DT DATE
);

CREATE TABLE DE2TM.DOVS_STG_CLIENTS
(CLIENT_ID VARCHAR2(20 BYTE),
LAST_NAME VARCHAR2(100 BYTE),
FIRST_NAME VARCHAR2(100 BYTE),
PATRONYMIC VARCHAR2(100 BYTE),
DATE_OF_BIRTH DATE,
PASSPORT_NUM VARCHAR2(15 BYTE),
PASSPORT_VALID_TO DATE,
PHONE VARCHAR2(20 BYTE),
CREATE_DT DATE,
UPDATE_DT DATE
);

CREATE TABLE DE2TM.DOVS_STG_PSSPRT_BL (
PASSPORT_NUM VARCHAR2(20 BYTE),
ENTRY_DT DATE)
;

CREATE TABLE DE2TM.DOVS_STG_TERMINALS(
TERMINAL_ID VARCHAR2(30 BYTE),
TERMINAL_TYPE VARCHAR2(30 BYTE),
TERMINAL_CITY VARCHAR2(120 BYTE),
TERMINAL_ADDRESS VARCHAR2(120 BYTE),
EFFECTIVE_FROM_DT DATE,
EFFECTIVE_TO_DT DATE
)
;

CREATE TABLE DE2TM.DOVS_STG_TRANSACTIONS(
TRANS_ID VARCHAR2(30 BYTE),
TRANS_DATE TIMESTAMP,
AMT DECIMAL(9,2),
CARD_NUM VARCHAR2(20 BYTE),
OPER_TYPE VARCHAR2(20 BYTE),
OPER_RESULT VARCHAR2(20 BYTE),
TERMINAL VARCHAR2(20 BYTE)
);

--DELETE

CREATE TABLE DE2TM.DOVS_STG_DEL_CARDS
(CARD_NUM CHAR(20 BYTE));

CREATE TABLE DE2TM.DOVS_STG_DEL_ACCOUNTS
(ACCOUNT_NUM VARCHAR2(20 BYTE));

CREATE TABLE DE2TM.DOVS_STG_DEL_CLIENTS
(CLIENT_ID VARCHAR2(20 BYTE));

CREATE TABLE DE2TM.DOVS_STG_DEL_TRMN
(TERMINAL_ID VARCHAR2(30 BYTE));

--META
CREATE TABLE DE2TM.DOVS_META_CARDS
(LAST_UPDATE DATE);

CREATE TABLE DE2TM.DOVS_META_ACCOUNTS
(LAST_UPDATE DATE);


CREATE TABLE DE2TM.DOVS_META_CLIENTS
(LAST_UPDATE DATE);

CREATE TABLE DE2TM.DOVS_META_PSSPRT_BL
(LAST_UPDATE DATE);

CREATE TABLE DE2TM.DOVS_META_TRANSACTIONS
(LAST_UPDATE DATE);

--REPORT

CREATE TABLE DE2TM.DOVS_REP_FRAUD(
    EVENT_DT VARCHAR2(30 BYTE),
    PASSPORT VARCHAR2(20 BYTE),
    FIO VARCHAR2(100 BYTE),
    PHONE VARCHAR2(20 BYTE),
    EVENT_TYPE VARCHAR2(200 BYTE),
    REPORT_DT DATE DEFAULT CURRENT_TIMESTAMP
);






--META FIRST ROW

INSERT INTO DE2TM.DOVS_META_CLIENTS (LAST_UPDATE)
VALUES (TO_DATE('1899-01-01','YYYY-MM-DD'));

INSERT INTO DE2TM.DOVS_META_ACCOUNTS (LAST_UPDATE)
VALUES (TO_DATE('1899-01-01','YYYY-MM-DD'));

INSERT INTO DE2TM.DOVS_META_CARDS (LAST_UPDATE)
VALUES (TO_DATE('1899-01-01','YYYY-MM-DD'));

INSERT INTO DE2TM.DOVS_META_PSSPRT_BL(LAST_UPDATE)
VALUES (TO_DATE('1899-01-01','YYYY-MM-DD'));

INSERT INTO DE2TM.DOVS_META_TRANSACTIONS(LAST_UPDATE)
VALUES (TO_DATE('1899-01-01','YYYY-MM-DD'));
COMMIT;







---stg
INSERT INTO DE2TM.DOVS_STG_ACCOUNTS
SELECT
ACCOUNT,VALID_TO,CLIENT,CREATE_DT,UPDATE_DT
FROM BANK.ACCOUNTS
WHERE COALESCE(CREATE_DT, UPDATE_DT) >
(SELECT
LAST_UPDATE
FROM DE2TM.DOVS_META_ACCOUNTS
)
;

INSERT INTO DE2TM.DOVS_STG_CARDS
SELECT
CARD_NUM,ACCOUNT,CREATE_DT,UPDATE_DT
FROM BANK.CARDS
WHERE COALESCE(CREATE_DT, UPDATE_DT) >
(SELECT
LAST_UPDATE
FROM DE2TM.DOVS_META_CARDS
)
;

INSERT INTO DE2TM.DOVS_STG_CLIENTS
SELECT
CLIENT_ID, LAST_NAME, FIRST_NAME, PATRONYMIC, DATE_OF_BIRTH,
PASSPORT_NUM, PASSPORT_VALID_TO, PHONE, CREATE_DT, UPDATE_DT
FROM BANK.CLIENTS
WHERE COALESCE(CREATE_DT, UPDATE_DT) >
(SELECT
LAST_UPDATE
FROM DE2TM.DOVS_META_CLIENTS
)
;
